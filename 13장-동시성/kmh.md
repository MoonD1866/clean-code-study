### 동시성

- 무엇과 언제를 분리하는, 결합을 없애는 전략
- 동시성은 다소 부하를 유발한다.
- 동시성은 복잡하다.
- 동시성 버그는 일반적으로 재현하기 어렵다.
- 동시성을 구현하려면 근본적인 설계 전략을 재고해야 한다.

### 동시성 문제 방어 원칙과 기술

**SRP**

- 동시성 코드는 독자적인 개발, 변경, 조율 주기가 있다.
- 동시성 코드에는 독자적인 난관이 있다. 다른 코드에서 겪는 난관과 다르며 훨씬 어렵다.
- 잘못 구현한 동시성 코드는 별의별 방식으로 실패한다. 주변에 있는 다른 코드가 발목을 잡지 않더라도 동시성 하나만으로도 충분히 어렵다.
- 동시성 코드는 다른코드와 분리하라.

**따름 정리 : 자료 범위를 제한하라**

- 보호할 임계영역을 빼먹어 공유 자료를 수정하는 모든 코드를 망가뜨린다.
- 모든 임계영역을 보호했는지 확인하느라 같은 노력과 수고를 반복한다.
- 버그 찾기가 더 어려워진다.
- 자료를 캡슐화하라. 공유 자료를 최대한 줄여라.

**따름 정리 : 자료 사본을 사용하라**

**따름 정리 : 스레드는 가능한 독립적으로 구현하라**

- 독자적인 스레드로, 가능하면 다른 프로세서에서, 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.

**라이브러리를 이용하라**

- 스레드 환경에서 안전한 컬렉션을 사용한다.
- 서로 무관한 작업을 수행할 때는 executor 프레임워크를 사용한다.
- 가능하다면 스레드가 차단되지 않는 방법을 사용한다.
- 일부 클래스 라이브러리는 스레드에 안전하지 못하다.

**스레드 환경에 안전한 컬렉션**

- ReentrantLock : 한 메서드에서 잠그고 다른 메서드에서 푸는 락
- Semaphore : 전형적인 세마포로 개수가 있는 락
- CountDownLatch : 지정한 수 만큼 이벤트가 발생하고 나서야 대기 중인 스레드를 모두 해제 하는 락
- 언어가 제공하는 클래스를 검토하라

**실행 모델을 이해하라**

- 한정된 자원 : 다중 스레드 환경에서 사용하는 자원으로 크기나 숫자가 제한적이다. DB연결, 길이가 일정한 읽기/쓰기 버퍼 등이 예시
- 상호 배제 : 한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 있는 경우를 가리킴.
- 기아 : 한 스레드나 여러 스레드가 계속 자원을 기다리는 상태
- 데드락 : 여러 스레드가 서로 끝나기를 기다리는 상태
- 라이브락 : 락을 거는 단계에서 각 스레드가 서로를 방해하는 상태

**동기화하는 메서드 사이에 존재하는 의존성을 이해하라**

- 공유 객체 하나에는 메서드 하나만 사용하라
- 여러 메서드가 필요한 상황에서는
- 클라이언트에서 잠금 : 클라이언트에서 첫 번째 메서드를 호출하기 전에 서버를 잠근다. 마지막 메서드를 호출할 때까지 잠금을 유지한다.
- 서버에서 잠금 : 서버에다 "서버를 잠그고 모든 메서드를 호출한 후 잠금을 해제하는" 메서드를 구현한다. 
- 연결 서버 : 잠금을 수행하는 중간 단계를 생성한다.

**동기화하는 부분을 작게 만들어라**

**종료 코드를 개발 초기부터 고민하고 동작하게 초기부터 구현하라**

**문제를 노출하는 테스트 케이스를 작성하라**

- 말이 안되는 실패는 잠정적인 스레드 문제로 취급하라
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 스레드 코드를 구현하라
- 다중 스레드를 쓰는 코드 부분을 상황에 맞춰 조정할 수 있게 작성하라
- 프로세서 수보다 많은 스레드를 돌려보라
- 다른 플랫폼에서 돌려보라
- 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라

**스레드 환경 밖에서 생기는 버그와 스레드 환경에서 생기는 버그를 동시에 디버깅하지 마라.**

**다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있게 스레드 코드를 구현하라**
- 한 스레드로 실행하거나, 여러 스레드로 실행하거나, 실행 중 스레드 수를 바꿔본다.
- 스레드 코드를 실제 환경이나 테스트 환경에서 돌려본다.
- 테스트 코드를 빨리, 천천히, 다양한 속도로 돌려본다.
- 반복 테스트가 가능하도록 테스트 케이스를 작성한다.
